{% extends "base.html" %}

{% block content %}
<style>
    /* --- CSS VARIABLES & THEME --- */
    [data-bs-theme="light"] {
        --sloth-bg-card: #ffffff;
        --sloth-bg-body: #f8f9fa;
        --sloth-text-muted: #6c757d;
        --sloth-border-color: #dee2e6;
    }
    [data-bs-theme="dark"] {
        --sloth-bg-card: #1e1e1e;
        --sloth-bg-body: #121212;
        --sloth-text-muted: #adb5bd; 
        --sloth-border-color: #333;
    }

    body { background-color: var(--sloth-bg-body); color: var(--bs-body-color); }
    .card { background-color: var(--sloth-bg-card); border-color: var(--sloth-border-color); }
    .table > :not(caption) > * > * { background-color: transparent; color: inherit; box-shadow: none; border-bottom-color: var(--sloth-border-color); }
    [data-bs-theme="dark"] tr { background-color: #181818; } 

    /* STICKY HEADER FIX */
    .sticky-header {
        position: sticky;
        top: 58px; /* Klebt jetzt UNTERHALB der Navbar (ca 58px hoch) */
        z-index: 900; /* Kleiner als Navbar (1050) damit Dropdown dr√ºber geht */
        background-color: var(--sloth-bg-body);
        padding-top: 15px;
        padding-bottom: 5px;
        margin-bottom: 10px;
        box-shadow: 0 10px 10px -10px rgba(0,0,0,0.1); 
    }

    /* ZEILEN FARBEN */
    .tr-office { background-color: rgba(40, 167, 69, 0.15) !important; }
    .tr-home { background-color: rgba(23, 162, 184, 0.15) !important; }
    .tr-holiday { background-color: rgba(108, 117, 125, 0.2) !important; }
    .tr-vacation { background-color: rgba(255, 193, 7, 0.2) !important; }
    .tr-sick { background-color: rgba(220, 53, 69, 0.2) !important; }
    .tr-weekend { background-color: rgba(0,0,0,0.05) !important; color: #888; }

    [data-bs-theme="dark"] .tr-office { background-color: #a3cfbb !important; color: #000 !important; font-weight: 500; }
    [data-bs-theme="dark"] .tr-home { background-color: #9eeaf9 !important; color: #000 !important; font-weight: 500; }
    [data-bs-theme="dark"] .tr-vacation { background-color: #fff3cd !important; color: #000 !important; font-weight: 500; }
    [data-bs-theme="dark"] .tr-sick { background-color: #f8d7da !important; color: #000 !important; font-weight: 500; }
    [data-bs-theme="dark"] .tr-holiday { background-color: #e2e3e5 !important; color: #000 !important; font-weight: 500; }
    [data-bs-theme="dark"] .tr-weekend { background-color: #262626 !important; color: #888 !important; }

    .table-input {
        background: transparent; border: 1px solid transparent; 
        width: 60px; text-align: center; color: inherit; font-weight: bold;
        border-radius: 4px; padding: 2px 0; transition: all 0.2s;
    }
    .table-input:hover, .table-input:focus { background: rgba(128,128,128,0.1); border-color: var(--sloth-text-muted); }
    .table-input::placeholder { opacity: 0.2; font-weight: normal; }

    /* Buttons & Layout */
    .btn-xs-status {
        width: 28px; height: 28px; border-radius: 6px; 
        font-size: 0.75rem; font-weight: bold;
        display: inline-flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s;
        border: 1px solid var(--sloth-border-color); 
        background-color: var(--sloth-bg-card); opacity: 0.5; color: var(--sloth-text-muted);
    }
    .btn-xs-status:hover { transform: scale(1.1); opacity: 1; }
    .btn-xs-status.active { opacity: 1; border-color: transparent; color: white !important; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    
    .st-f.active { background-color: #6c757d; }
    .st-u.active { background-color: #ffc107; color: #000 !important; }
    .st-k.active { background-color: #dc3545; }

    .quota-card {
        background: var(--sloth-bg-card); border-radius: 12px; padding: 15px;
        border: 1px solid var(--sloth-border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .progress-sloth { height: 10px; border-radius: 5px; background-color: rgba(128,128,128,0.1); margin-top: 5px; overflow: hidden; }
    .progress-bar-sloth { background-color: #ffc107; height: 100%; transition: width 0.5s; }
    
    .bg-office { background-color: #28a745 !important; color: white; }
    .bg-home { background-color: #17a2b8 !important; color: white; }
    .bg-doctor { background-color: #dc3545 !important; color: white; }
    .type-office { border-left: 5px solid #28a745; }
    .type-home { border-left: 5px solid #17a2b8; }
    .type-doctor { border-left: 5px solid #dc3545; }

    .view-switcher { background: rgba(128,128,128,0.1); border-radius: 20px; padding: 4px; display: inline-flex; }
    .view-btn { border: none; background: transparent; padding: 5px 15px; border-radius: 16px; font-size: 0.9rem; color: var(--sloth-text-muted); transition: all 0.2s; }
    .view-btn.active { background: var(--sloth-bg-card); color: var(--sloth-primary); font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    [data-bs-theme="dark"] .view-btn.active { color: white; background: #444; }

    .comment-input { background: transparent; border: none; width: 100%; color: inherit; font-size: 0.9rem; padding: 2px 5px; border-bottom: 1px solid transparent; }
    .comment-input:focus { outline: none; border-bottom: 1px solid var(--sloth-text-muted); }
    .footer-sarcasm { color: var(--sloth-text-muted) !important; opacity: 0.6; }
    .cursor-pointer { cursor: pointer; }
    .sloth-header-card { background-color: var(--sloth-bg-card); border: 1px solid var(--sloth-border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-radius: 12px; padding: 10px; margin-bottom: 20px; }
</style>

<div id="app" class="container mt-3 mb-5" v-cloak>

    <div class="sticky-header">
        
        <div class="quota-card mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="text-muted small fw-bold text-uppercase">B√ºro-Quote (40%)</span>
                <span class="text-danger fw-bold fs-5">[[ quota.needed ]] h</span>
            </div>
            <div class="d-flex justify-content-between small mb-1 text-muted">
                <span>Ist: [[ quota.current ]] h</span>
                <span>Ziel (dynamisch): [[ quota.target ]] h</span>
            </div>
            <div class="progress-sloth">
                <div class="progress-bar-sloth" :style="{ width: quota.percent + '%' }"></div>
            </div>
            <div class="text-end mt-2">
                <span class="badge bg-secondary opacity-75 fw-normal" style="font-size: 0.7rem;">
                    Abz√ºge (F/U/K): [[ quota.deduction ]] h
                </span>
            </div>
        </div>

        <div class="text-center">
            <div class="view-switcher">
                <button class="view-btn" :class="{active: viewMode === 'day'}" @click="viewMode = 'day'">
                    <i class="bi bi-calendar-day"></i> Tag
                </button>
                <button class="view-btn" :class="{active: viewMode === 'month'}" @click="viewMode = 'month'">
                    <i class="bi bi-table"></i> Liste
                </button>
            </div>
        </div>
    </div>
    <div v-show="viewMode === 'day'" class="animate-fade">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-secondary btn-sm rounded-circle shadow-sm" @click="shiftDay(-1)"><i class="bi bi-chevron-left"></i></button>
            <h5 class="m-0 fw-bold">[[ displayDateDayView ]]</h5>
            <button class="btn btn-outline-secondary btn-sm rounded-circle shadow-sm" @click="shiftDay(1)"><i class="bi bi-chevron-right"></i></button>
        </div>

        <div v-if="!isNonWorkDay && prediction.target !== '--:--'" class="card mb-3 border-0 shadow-sm">
            <div class="card-body py-2 d-flex justify-content-around align-items-center">
                <div class="text-center">
                    <small class="text-muted d-block text-uppercase" style="font-size: 0.65rem">Soll ([[ settings.sollStunden ]]h)</small>
                    <strong class="text-primary">[[ prediction.target ]]</strong>
                </div>
                <div class="vr opacity-25"></div>
                <div class="text-center">
                    <small class="text-muted d-block text-uppercase" style="font-size: 0.65rem">Max (10h)</small>
                    <strong class="text-danger">[[ prediction.max ]]</strong>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-center gap-2 mb-4">
            <div class="btn-xs-status st-f" :class="{active: dayStatus === 'F'}" style="width:50px; height:40px; font-size:1rem; opacity: 1; border: 1px solid var(--sloth-border-color);" @click="toggleStatus('F')">F</div>
            <div class="btn-xs-status st-u" :class="{active: dayStatus === 'U'}" style="width:50px; height:40px; font-size:1rem; opacity: 1; border: 1px solid var(--sloth-border-color);" @click="toggleStatus('U')">U</div>
            <div class="btn-xs-status st-k" :class="{active: dayStatus === 'K'}" style="width:50px; height:40px; font-size:1rem; opacity: 1; border: 1px solid var(--sloth-border-color);" @click="toggleStatus('K')">K</div>
        </div>

        <div v-if="!isNonWorkDay">
            <transition-group name="list" tag="div">
                <div v-for="(block, index) in blocks" :key="block.id" class="card mb-2 shadow-sm border" :class="'type-' + block.type">
                    <div class="card-body p-2 d-flex align-items-center gap-2">
                        <div class="dropdown">
                            <button class="btn btn-sm dropdown-toggle text-white shadow-sm" :class="'bg-' + block.type" type="button" data-bs-toggle="dropdown" style="width: 40px;">
                                <i class="bi" :class="getTypeIcon(block.type)"></i>
                            </button>
                            <ul class="dropdown-menu shadow">
                                <li><a class="dropdown-item" @click="changeBlockType($event, index, 'office')"><i class="bi bi-building me-2 text-success"></i>B√ºro</a></li>
                                <li><a class="dropdown-item" @click="changeBlockType($event, index, 'home')"><i class="bi bi-house me-2 text-info"></i>Home</a></li>
                                <li><a class="dropdown-item text-danger" @click="changeBlockType($event, index, 'doctor')"><i class="bi bi-bandaid me-2"></i>Arzt</a></li>
                            </ul>
                        </div>
                        <input type="text" class="form-control text-center p-1 fw-bold" v-model="block.start" placeholder="08:00" @blur="formatTimeInput(block, 'start')" @input="triggerAutoSave">
                        <span>-</span>
                        <input type="text" class="form-control text-center p-1 fw-bold" v-model="block.end" placeholder="16:30" @blur="formatTimeInput(block, 'end')" @input="triggerAutoSave">
                        <button class="btn btn-link text-muted p-0 ms-auto" @click="removeBlock(index)"><i class="bi bi-x-lg"></i></button>
                    </div>
                </div>
            </transition-group>

            <div class="d-grid gap-2 mt-3">
                <button class="btn btn-outline-secondary border-dashed" @click="addBlock('office')" style="border-style: dashed; opacity: 0.7;">
                    <i class="bi bi-plus-lg"></i> Eintrag
                </button>
            </div>
            
            <div class="text-center mt-4 small p-2 rounded shadow-sm border" style="background-color: var(--sloth-bg-card); color: var(--sloth-text-muted);">
                <div class="d-flex justify-content-center gap-3">
                    <span>SAP: <strong>[[ formatH(totals.sapTime) ]]</strong></span>
                    <div class="vr"></div>
                    <span>CATS: <strong>[[ formatH(totals.catsTime) ]]</strong></span>
                </div>
                <div v-if="totals.pause > 0" class="text-warning mt-1" style="font-size: 0.8rem;">
                    <i class="bi bi-cup-hot"></i> Pause: -[[ totals.pause ]]m
                </div>
                <div class="fw-bold mt-2 text-primary fs-6 border-top pt-1">Saldo: [[ totals.saldo ]]</div>
            </div>
        </div>
        
        <div v-else class="alert text-center mt-3 shadow-sm border" :class="statusAlertClass">
            <h5 class="m-0">[[ getStatusText(dayStatus) ]]</h5>
        </div>
    </div>

    <div v-show="viewMode === 'month'" class="animate-fade">
        <div class="d-flex justify-content-between align-items-center mb-3 sloth-header-card">
            <button class="btn btn-sm btn-outline-secondary" @click="shiftMonth(-1)"><i class="bi bi-chevron-left"></i></button>
            <h5 class="m-0 fw-bold">[[ displayMonthName ]]</h5>
            <button class="btn btn-sm btn-outline-secondary" @click="shiftMonth(1)"><i class="bi bi-chevron-right"></i></button>
        </div>

        <div class="table-responsive rounded shadow-sm border" style="background-color: var(--sloth-bg-card);">
            <table class="table mb-0 text-center align-middle" style="font-size: 0.9rem; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th class="text-start ps-3 py-3 align-middle">Datum</th>
                        <th colspan="2" style="min-width: 220px;" class="align-middle">Zeiten</th>
                        <th class="text-center align-middle">SAP</th>
                        <th style="min-width: 110px;">Status</th>
                        <th style="min-width: 100px;" class="text-start">Kommentar</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="day in monthDays" :key="day.iso" :class="getRowClass(day)">
                        <td class="text-start ps-3 cursor-pointer" @click="jumpToDay(day.iso)">
                            <div class="fw-bold" :class="{'text-primary': day.isToday}">
                                [[ day.dayShort ]]., [[ day.dateNum ]].
                            </div>
                            <div class="opacity-75" style="font-size: 0.7rem;">KW [[ day.kw ]]</div>
                        </td>
                        <td colspan="2" class="p-1 align-top" style="min-width: 220px;">
                            <div v-if="!day.status">
                                <div v-for="(block, index) in day.blocks" :key="block.id" class="d-flex align-items-center gap-1 mb-1">
                                    <div class="dropdown">
                                        <button class="btn btn-sm dropdown-toggle text-white shadow-sm" :class="'bg-' + block.type" type="button" data-bs-toggle="dropdown" style="width: 35px; height: 35px;">
                                            <i class="bi" :class="getTypeIcon(block.type)"></i>
                                        </button>
                                        <ul class="dropdown-menu shadow">
                                            <li><a class="dropdown-item" @click="changeListBlockType($event, day, index, 'office')"><i class="bi bi-building me-2 text-success"></i>B√ºro</a></li>
                                            <li><a class="dropdown-item" @click="changeListBlockType($event, day, index, 'home')"><i class="bi bi-house me-2 text-info"></i>Home</a></li>
                                            <li><a class="dropdown-item text-danger" @click="changeListBlockType($event, day, index, 'doctor')"><i class="bi bi-bandaid me-2"></i>Arzt</a></li>
                                        </ul>
                                    </div>
                                    <input type="text" class="table-input" v-model="block.start" @blur="formatListTime(day, index, 'start')" @input="triggerListSave(day)">
                                    <input type="text" class="table-input" v-model="block.end" @blur="formatListTime(day, index, 'end')" @input="triggerListSave(day)">
                                    <button class="btn btn-link text-danger p-0" @click="removeListBlock(day, index)"><i class="bi bi-x"></i></button>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary border-dashed w-100 mt-1" @click="addListBlock(day, 'office')" style="border-style: dashed; opacity: 0.7;">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        </td>
                        <td class="cursor-pointer fw-bold" @click="jumpToDay(day.iso)" style="color: inherit;">
                            [[ day.sapTime > 0 ? formatH(day.sapTime) : '0' ]]
                        </td>
                        <td>
                            <div class="d-flex justify-content-center gap-1">
                                <div class="btn-xs-status st-f" :class="{active: day.status === 'F'}" @click.stop="quickToggle(day, 'F')">F</div>
                                <div class="btn-xs-status st-u" :class="{active: day.status === 'U'}" @click.stop="quickToggle(day, 'U')">U</div>
                                <div class="btn-xs-status st-k" :class="{active: day.status === 'K'}" @click.stop="quickToggle(day, 'K')">K</div>
                            </div>
                        </td>
                        <td>
                            <input type="text" class="comment-input" v-model.lazy="day.comment" 
                                   :placeholder="day.placeholder" @change="updateComment(day)">
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="text-center mt-4">
            <a href="#" @click.prevent="resetMonth" class="text-danger opacity-75 small">
                <i class="bi bi-radioactive"></i> Dieses Monat zur√ºcksetzen
            </a>
        </div>
    </div>

    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 99;">
        <div v-if="saveState === 'saved'" class="text-success bg-white rounded-circle shadow p-2">
            <i class="bi bi-check-lg fs-4"></i>
        </div>
        <div v-if="saveState === 'saving'" class="text-warning bg-white rounded-circle shadow p-2">
            <div class="spinner-border spinner-border-sm"></div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    const { createApp } = Vue;

    createApp({
        delimiters: ['[[', ']]'], 
        data() {
            return {
                currentDateObj: new Date(),
                viewMode: localStorage.getItem('viewMode') || 'day',
                dayStatus: null, 
                blocks: [], 
                entriesCache: [],
                holidaysMap: {},
                saveState: 'idle', 
                saveTimer: null,
                settings: {
                    sollStunden: 7.70,
                    deductionPerDay: 3.08,
                    arztStart: 480, arztEnde: 972
                }
            }
        },
        watch: {
            viewMode(newVal) { localStorage.setItem('viewMode', newVal); }
        },
        computed: {
            deductionPerDay() {
                return (this.settings.sollStunden * 0.40).toFixed(2);
            },

            isoDate() { return this.formatIsoDate(this.currentDateObj); },
            isoMonth() { return this.isoDate.substring(0, 7); },

            displayDateDayView() {
                return this.currentDateObj.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });
            },
            displayMonthName() {
                return this.currentDateObj.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            },

            isNonWorkDay() { return ['F', 'U', 'K'].includes(this.dayStatus); },
            
            statusAlertClass() {
                if(this.dayStatus === 'F') return 'alert-secondary';
                if(this.dayStatus === 'U') return 'alert-warning';
                if(this.dayStatus === 'K') return 'alert-danger';
                return '';
            },

            totals() {
                let sapMin = 0; let catsMin = 0;
                this.blocks.forEach(b => {
                    let s = this.toMin(b.start); let e = this.toMin(b.end);
                    if (s >= e) return;
                    let dur = e - s;
                    if (b.type === 'doctor') {
                        let vs = Math.max(s, this.settings.arztStart);
                        let ve = Math.min(e, this.settings.arztEnde);
                        if (ve > vs) sapMin += (ve - vs);
                    } else {
                        sapMin += dur; catsMin += dur;
                    }
                });
                let pause = 0;
                if (sapMin > 360) { pause = 30; sapMin -= 30; catsMin -= 30; }
                let ist = sapMin / 60;
                let saldoVal = this.isNonWorkDay ? 0 : (ist - this.settings.sollStunden);
                return { sapTime: Math.max(0, sapMin), catsTime: Math.max(0, catsMin), pause, saldo: (saldoVal > 0 ? '+' : '') + saldoVal.toFixed(2) + ' h' };
            },

            prediction() {
                if (this.blocks.length === 0 || this.isNonWorkDay) return { target: '--:--', max: '--:--' };
                let firstStart = 9999; let lastEnd = 0;
                this.blocks.forEach(b => {
                    let s = this.toMin(b.start); let e = this.toMin(b.end);
                    if (s > 0 && s < firstStart) firstStart = s;
                    if (e > lastEnd) lastEnd = e;
                });
                if (firstStart === 9999) return { target: '--:--', max: '--:--' };
                let currentNetto = this.totals.sapTime;
                let remaining = (this.settings.sollStunden * 60) - currentNetto;
                if (remaining <= 0) return { target: '‚úî', max: '...' };
                let finish = lastEnd + remaining;
                if (this.totals.pause === 0 && (currentNetto + remaining) > 360) finish += 30;
                
                // Berechnung immer ab firstStart, falls lastEnd unplausibel
                let base = (lastEnd > 0 && lastEnd > firstStart) ? lastEnd : firstStart;
                if(base === firstStart) { 
                    // Wenn noch keine Arbeit erfasst (nur Startzeit), dann addiere Soll auf Start
                    finish = firstStart + (this.settings.sollStunden * 60) + (this.settings.sollStunden > 6 ? 30 : 0);
                }

                let maxTime = firstStart + 630; 
                return { target: this.minToString(finish), max: this.minToString(maxTime) };
            },

            quota() {
                let officeMinSum = 0;
                let deductionCount = 0;
                let y = this.currentDateObj.getFullYear();
                let m = this.currentDateObj.getMonth();
                let daysInMonth = new Date(y, m + 1, 0).getDate();
                let workDaysCount = 0;
                for(let d=1; d<=daysInMonth; d++) {
                    let tempDate = new Date(y, m, d);
                    let wd = tempDate.getDay();
                    if(wd !== 0 && wd !== 6) workDaysCount++;
                }
                
                let dynamicTarget = workDaysCount * this.settings.sollStunden * 0.40;

                this.entriesCache.forEach(e => {
                    const d = new Date(e.date);
                    const dayNum = d.getDay();
                    const isWeekend = (dayNum === 0 || dayNum === 6);
                    if(['F','U','K'].includes(e.status) && !isWeekend) deductionCount++;
                    else {
                        (e.blocks || []).forEach(b => {
                            if(b.type === 'office') {
                                let s = this.toMin(b.start); let e = this.toMin(b.end);
                                if(e>s) officeMinSum += (e - s);
                            }
                        });
                    }
                });

                for(let dateStr in this.holidaysMap) {
                    if(!this.entriesCache.find(e => e.date === dateStr)) {
                        const d = new Date(dateStr);
                        const dayNum = d.getDay();
                        if(dayNum !== 0 && dayNum !== 6) deductionCount++;
                    }
                }

                let deductionTotal = deductionCount * this.deductionPerDay;
                let targetAdjusted = Math.max(0, dynamicTarget - deductionTotal);
                let currentHours = officeMinSum / 60;
                let percent = targetAdjusted > 0 ? (currentHours / targetAdjusted) * 100 : 100;
                
                return {
                    current: currentHours.toFixed(2),
                    target: targetAdjusted.toFixed(2),
                    deduction: deductionTotal.toFixed(2),
                    needed: Math.max(0, targetAdjusted - currentHours).toFixed(2),
                    percent: Math.min(100, percent)
                };
            },

            monthDays() {
                let days = [];
                let year = this.currentDateObj.getFullYear();
                let month = this.currentDateObj.getMonth();
                let date = new Date(year, month, 1);
                const todayIso = this.formatIsoDate(new Date());

                while (date.getMonth() === month) {
                    let iso = this.formatIsoDate(date);
                    let entry = this.entriesCache.find(e => e.date === iso);
                    let holidayName = this.holidaysMap[iso];
                    let status = entry ? entry.status : (holidayName ? 'F' : null);
                    
                    let blocks = (entry && entry.blocks) ? JSON.parse(JSON.stringify(entry.blocks)) : [];
                    let sapT = 0;
                    let hasOffice = false;
                    let hasHome = false;
                    
                    if(entry && !status) {
                        let tempSap = 0;
                        blocks.forEach(b => {
                            let hasContent = (b.start && b.start.length >= 3) || (b.end && b.end.length >= 3);
                            if(hasContent) {
                                if(b.type === 'office') hasOffice = true;
                                if(b.type === 'home') hasHome = true;
                            }

                            let s = this.toMin(b.start); let e = this.toMin(b.end);
                            if(e>s) {
                                if(b.type==='doctor') {
                                    let vs = Math.max(s, this.settings.arztStart); let ve = Math.min(e, this.settings.arztEnde);
                                    if(ve>vs) tempSap += (ve-vs);
                                } else tempSap += (e-s);
                            }
                        });
                        if(tempSap > 360) tempSap -= 30;
                        sapT = Math.max(0, tempSap);
                    }

                    let dayName = date.toLocaleDateString('de-DE', { weekday: 'long' });
                    let isWeekend = (date.getDay()===0 || date.getDay()===6);
                    let ph = '';
                    if(isWeekend) ph = dayName;
                    else if(holidayName) ph = holidayName;

                    days.push({
                        iso: iso,
                        dateNum: date.getDate(),
                        dayShort: date.toLocaleDateString('de-DE', { weekday: 'short' }),
                        kw: this.getKw(date),
                        status: status,
                        sapTime: sapT,
                        blocks: blocks,
                        isWeekend: isWeekend,
                        isToday: (iso === todayIso),
                        hasOffice: hasOffice,
                        hasHome: hasHome,
                        comment: entry ? entry.comment : '',
                        placeholder: ph
                    });
                    date.setDate(date.getDate() + 1);
                }
                return days;
            }
        },
        methods: {
            changeBlockType(event, index, newType) {
                let oldBlock = this.blocks[index];
                this.blocks.splice(index, 1, { ...oldBlock, type: newType });
                this.triggerAutoSave();

                // Dropdown nach Auswahl schlie√üen
                const dropdownToggle = event.target.closest('.dropdown').querySelector('[data-bs-toggle="dropdown"]');
                if (dropdownToggle) {
                    const dropdown = bootstrap.Dropdown.getInstance(dropdownToggle);
                    if (dropdown) dropdown.hide();
                }
            },

            // --- NEUE METHODEN F√úR LISTENANSICHT ---
            addListBlock(day, type) {
                if(this.saveTimer) clearTimeout(this.saveTimer);
                this.saveState = 'idle';

                // Wenn ein Status (F,U,K) gesetzt ist, wird er durch die Zeiteingabe entfernt
                if (day.status) {
                    day.status = null;
                    let entry = this.entriesCache.find(e => e.date === day.iso);
                    if (entry) entry.status = null;
                }
                day.blocks.push({ id: Date.now(), type: type, start: '', end: '' });
                this.triggerListSave(day);
            },
            removeListBlock(day, index) {
                if(this.saveTimer) clearTimeout(this.saveTimer);
                this.saveState = 'idle';

                day.blocks.splice(index, 1);
                this.triggerListSave(day);
            },
            changeListBlockType(event, day, index, newType) {
                day.blocks[index].type = newType;
                this.triggerListSave(day);
                // Dropdown schlie√üen
                const dropdownToggle = event.target.closest('.dropdown').querySelector('[data-bs-toggle="dropdown"]');
                if (dropdownToggle) {
                    const dropdown = bootstrap.Dropdown.getInstance(dropdownToggle);
                    if (dropdown) dropdown.hide();
                }
            },
            formatListTime(day, index, field) {
                let block = day.blocks[index];
                let val = block[field];
                if(!val) return;

                let clean = val.replace(/[^0-9]/g, '');
                let h = 0, m = 0;
                if(clean.length >= 5) { // HHMMSS
                    h = parseInt(clean.substring(0,2)); m = parseInt(clean.substring(2,4));
                    if(parseInt(clean.substring(4,6)) >= 30) m++;
                } else if (clean.length === 4) { h = parseInt(clean.substring(0,2)); m = parseInt(clean.substring(2,4));
                } else if (clean.length === 3) { h = parseInt(clean.substring(0,1)); m = parseInt(clean.substring(1,3));
                } else { h = parseInt(clean); }

                if(h > 23) h = 23; if(m > 59) m = 59;
                block[field] = h.toString().padStart(2,'0') + ':' + m.toString().padStart(2,'0');
                this.triggerListSave(day);
            },
            triggerListSave(day) {
                this.saveState = 'saving';
                if(this.saveTimer) clearTimeout(this.saveTimer);
                this.saveTimer = setTimeout(() => {
                    let entry = this.entriesCache.find(e => e.date === day.iso);
                    if (!entry) {
                        entry = { date: day.iso, blocks: [], status: null, comment: day.comment };
                        this.entriesCache.push(entry);
                    }
                    entry.blocks = day.blocks;
                    entry.status = day.status;
                    this.saveSingleEntry(entry);
                }, 350);
            },

            formatIsoDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            getRowClass(day) {
                if (day.status === 'F') return 'tr-holiday';
                if (day.status === 'U') return 'tr-vacation';
                if (day.status === 'K') return 'tr-sick';
                if (day.hasOffice) return 'tr-office';
                if (day.hasHome) return 'tr-home';
                if (day.isWeekend) return 'tr-weekend';
                return '';
            },

            formatTimeInput(block, field) {
                let val = block[field];
                if(!val) return;
                let clean = val.replace(/[^0-9]/g, '');
                let h = 0, m = 0;
                
                // --- FIX: SEKUNDEN SUPPORT (Gleiche Logik) ---
                if(clean.length >= 5) {
                    h = parseInt(clean.substring(0,2));
                    m = parseInt(clean.substring(2,4));
                    let s = parseInt(clean.substring(4,6));
                    if(s >= 30) m++;
                } else if (clean.length === 4) {
                    h = parseInt(clean.substring(0,2)); m = parseInt(clean.substring(2,4));
                } else if (clean.length === 3) {
                    h = parseInt(clean.substring(0,1)); m = parseInt(clean.substring(1,3));
                } else {
                    h = parseInt(clean);
                }

                if(h > 23) h = 23; if(m > 59) m = 59;
                block[field] = h.toString().padStart(2,'0') + ':' + m.toString().padStart(2,'0');
                this.triggerAutoSave();
            },
            
            toMin(str) {
                if (!str || str.length < 3) return 0;
                let clean = str.replace(':','').padStart(4, '0');
                return (parseInt(clean.substr(0,2))*60) + parseInt(clean.substr(2,2));
            },
            minToString(min) {
                let h = Math.floor(min / 60); let m = min % 60;
                return h.toString().padStart(2,'0') + ':' + m.toString().padStart(2,'0');
            },
            formatH(min) { return (min / 60).toFixed(2); },
            getTypeIcon(t) { return (t==='office'?'bi-building':(t==='home'?'bi-house':'bi-bandaid')); },
            getStatusText(s) { return (s==='F'?'Feiertag üéÑ':(s==='U'?'Urlaub üå¥':(s==='K'?'Krank ü§í':''))); },
            getKw(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            },

            shiftDay(offset) {
                let d = new Date(this.currentDateObj);
                d.setDate(d.getDate() + offset);
                let oldMonth = this.currentDateObj.getMonth();
                this.currentDateObj = d;
                if(d.getMonth() !== oldMonth) this.loadMonthData();
                else this.loadFromCache();
            },
            shiftMonth(offset) {
                let d = new Date(this.currentDateObj);
                d.setDate(1); d.setMonth(d.getMonth() + offset);
                this.currentDateObj = d;
                this.loadMonthData();
            },

            jumpToDay(iso) {
                this.currentDateObj = new Date(iso);
                this.viewMode = 'day';
                this.loadFromCache();
            },

            toggleStatus(s) {
                this.dayStatus = (this.dayStatus === s) ? null : s;
                this.triggerAutoSave();
            },
            
            async quickToggle(day, status) {
                // Verhindert Race-Condition: Bricht einen laufenden Auto-Save ab.
                if(this.saveTimer) clearTimeout(this.saveTimer);
                this.saveState = 'idle';

                const newStatus = (day.status === status) ? null : status;
                day.status = newStatus; // UI sofort aktualisieren f√ºr bessere R√ºckmeldung

                let entry = this.entriesCache.find(e => e.date === day.iso);
                if(entry) entry.status = newStatus;
                else {
                    entry = { date: day.iso, blocks: [], status: newStatus, comment: '' };
                    this.entriesCache.push(entry);
                }
                this.saveSingleEntry(entry);
            },

            updateComment(day) {
                let entry = this.entriesCache.find(e => e.date === day.iso);
                if(entry) {
                    entry.comment = day.comment;
                } else {
                    entry = { date: day.iso, blocks: [], status: null, comment: day.comment };
                    this.entriesCache.push(entry);
                }
                this.saveSingleEntry(entry);
            },

            addBlock(type) {
                this.blocks.push({ id: Date.now(), type: type, start: '', end: '' });
                this.triggerAutoSave();
            },
            removeBlock(idx) {
                this.blocks.splice(idx, 1);
                this.triggerAutoSave();
            },
            updateBlock(block, field, val) {
                block[field] = val;
                this.triggerAutoSave();
            },

            triggerAutoSave() {
                this.saveState = 'saving';
                if(this.saveTimer) clearTimeout(this.saveTimer);
                this.saveTimer = setTimeout(() => { this.saveData(); }, 250);
            },

            async saveData() {
                const payload = { date: this.isoDate, blocks: this.blocks, status: this.dayStatus, comment: '' };
                let existing = this.entriesCache.find(e => e.date === this.isoDate);
                if(existing) payload.comment = existing.comment;
                await this.saveSingleEntry(payload);
            },

            async saveSingleEntry(payload) {
                this.saveState = 'saving';
                try {
                    let existing = this.entriesCache.find(e => e.date === payload.date);
                    if(existing) {
                        existing.blocks = payload.blocks;
                        existing.status = payload.status;
                        existing.comment = payload.comment;
                    } else {
                        this.entriesCache.push(JSON.parse(JSON.stringify(payload)));
                    }
                    await axios.post('/api/save_entry', payload);
                    this.saveState = 'saved';
                    setTimeout(() => { if(this.saveState === 'saved') this.saveState = 'idle'; }, 2000);
                } catch(e) { console.error(e); this.saveState = 'idle'; }
            },

            async loadMonthData() {
                try {
                    const res = await axios.get(`/api/get_entries?month=${this.isoMonth}`);
                    this.entriesCache = res.data.entries;
                    this.holidaysMap = res.data.holidays || {};
                    // NEU: Settings √ºbernehmen!
                    if(res.data.settings && res.data.settings.sollStunden) {
                        this.settings.sollStunden = parseFloat(res.data.settings.sollStunden);
                    }
                    this.loadFromCache();
                } catch(e) { console.error(e); }
            },

            loadFromCache() {
                const iso = this.isoDate;
                let isHol = !!this.holidaysMap[iso];
                let entry = this.entriesCache.find(e => e.date === iso);
                if (entry) {
                    this.blocks = JSON.parse(JSON.stringify(entry.blocks || []));
                    this.dayStatus = entry.status;
                } else {
                    this.blocks = [];
                    this.dayStatus = isHol ? 'F' : null;
                }
            }

            async resetMonth() {
                if(!confirm("M√∂chtest du wirklich alle Eintr√§ge f√ºr diesen Monat l√∂schen?")) return;
                
                try {
                    await axios.post('/api/reset_month', { month: this.isoMonth });
                    // Daten neu laden, damit die Tabelle leer wird
                    this.loadMonthData();
                } catch(e) {
                    console.error(e);
                    alert("Fehler beim Zur√ºcksetzen: " + (e.response?.data?.error || "Unbekannt"));
                }
            }
        },
        mounted() {
            this.loadMonthData();
        }
    }).mount('#app');
</script>
{% endblock %}