{% extends "base.html" %}

{% block content %}
<style>
    /* --- DARK MODE FIXES --- */
    [data-bs-theme="dark"] body {
        background-color: #121212;
        color: #e0e0e0;
    }
    
    [data-bs-theme="dark"] .card {
        background-color: #1e1e1e; /* Dunklerer Hintergrund f√ºr Cards */
        border-color: #333;
    }

    /* Fix f√ºr Inputs im Dark Mode */
    [data-bs-theme="dark"] .form-control {
        background-color: #2d2d2d;
        border: 1px solid #444;
        color: #fff;
    }
    
    [data-bs-theme="dark"] .form-control:focus {
        background-color: #333;
        border-color: #5c7cfa;
        color: #fff;
        box-shadow: 0 0 0 0.25rem rgba(92, 124, 250, 0.25);
    }

    [data-bs-theme="dark"] .input-group-text {
        background-color: #252525;
        border-color: #444;
        color: #aaa;
    }

    /* --- SLOTH DASHBOARD STYLES --- */
    .stats-card {
        border-radius: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .stat-box { text-align: center; border-right: 1px solid rgba(255,255,255,0.2); }
    .stat-box:last-child { border-right: none; }
    .stat-value { font-size: 1.8rem; font-weight: bold; display: block; }
    .stat-label { font-size: 0.8rem; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }

    .time-card { margin-bottom: 15px; }
    .icon-box { width: 40px; text-align: center; }
    
    /* Farben f√ºr die Kategorien */
    .border-office { border-left: 5px solid #4dabf7 !important; }
    .border-home { border-left: 5px solid #da77f2 !important; }
    .text-office { color: #4dabf7; }
    .text-home { color: #da77f2; }

    /* Floating Save Button f√ºr Mobile */
    .fab-save {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        font-size: 24px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        z-index: 1000;
    }
</style>

<div id="app" class="container mt-3" v-cloak>
    
    <div class="stats-card">
        <div class="row">
            <div class="col-4 stat-box">
                <span class="stat-value">[[ buroQuote ]]%</span>
                <span class="stat-label">B√ºro</span>
            </div>
            <div class="col-4 stat-box">
                <span class="stat-value">[[ saldo ]]</span>
                <span class="stat-label">Saldo</span>
            </div>
            <div class="col-4 stat-box">
                <span class="stat-value">[[ restSoll ]]</span>
                <span class="stat-label">Rest</span>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm"><i class="bi bi-chevron-left"></i></button>
        <h5 class="m-0 fw-bold">Heute</h5>
        <button class="btn btn-outline-secondary btn-sm"><i class="bi bi-chevron-right"></i></button>
    </div>

    <div class="card time-card border-office">
        <div class="card-body p-2">
            <div class="d-flex align-items-center mb-2">
                <div class="icon-box text-office"><i class="bi bi-building-fill fs-4"></i></div>
                <div class="fw-bold flex-grow-1">B√ºro Anwesenheit</div>
            </div>
            <div class="input-group">
                <input type="tel" class="form-control text-center" v-model="buroStart" placeholder="0800" maxlength="4">
                <span class="input-group-text border-0 bg-transparent">-</span>
                <input type="tel" class="form-control text-center" v-model="buroEnde" placeholder="1630" maxlength="4">
            </div>
        </div>
    </div>

    <div class="card time-card border-home">
        <div class="card-body p-2">
            <div class="d-flex align-items-center mb-2">
                <div class="icon-box text-home"><i class="bi bi-house-heart-fill fs-4"></i></div>
                <div class="fw-bold flex-grow-1">Home Office</div>
            </div>
            <div class="input-group">
                <input type="tel" class="form-control text-center" v-model="homeStart" placeholder="Start" maxlength="4">
                <span class="input-group-text border-0 bg-transparent">-</span>
                <input type="tel" class="form-control text-center" v-model="homeEnde" placeholder="Ende" maxlength="4">
            </div>
        </div>
    </div>

    <div class="card time-card border-danger border-start border-3">
        <div class="card-body p-2">
            <div class="d-flex align-items-center">
                <div class="icon-box text-danger"><i class="bi bi-bandaid-fill fs-4"></i></div>
                <div class="flex-grow-1">Arzt / Amt</div>
                <div style="width: 100px;">
                    <input type="number" class="form-control text-center" v-model="arztMin" placeholder="Min">
                </div>
            </div>
            <div class="form-text text-muted small ms-5" v-if="arztMin > 120">
                ‚ö†Ô∏è Best√§tigung f√ºr SAP Upload erforderlich!
            </div>
        </div>
    </div>

    <div class="mb-5">
        <input type="text" class="form-control" placeholder="Notiz f√ºr diesen Tag..." v-model="kommentar">
    </div>

    <button class="btn btn-primary fab-save" @click="saveData">
        <i class="bi bi-floppy2-fill"></i>
    </button>

    <div class="text-center text-muted small mt-4">
        Gesamtzeit: [[ formatMinutes(totalMinuten) ]] h<br>
        <span v-if="pauseAbzug > 0" class="text-warning">Automatische Pause: -[[ pauseAbzug ]] Min</span>
    </div>

</div>
{% endblock %}


{% block scripts %}
<script>
    const { createApp } = Vue;

    createApp({
        // Wir √§ndern die Vue-Klammern auf [[ ]], damit sie sich nicht mit Jinja bei√üen.
        delimiters: ['[[', ']]'], 
        
        data() {
            return {
                sollStunden: 7.70,
                buroStart: '',
                buroEnde: '',
                homeStart: '',
                homeEnde: '',
                arztMin: '',
                kommentar: '',
                pauseAbzug: 0
            }
        },
        computed: {
            // Hilfsfunktion: Wandelt "0800" in Minuten um
            parseTime() {
                return (timeStr) => {
                    if (!timeStr || timeStr.length < 3) return 0;
                    // Mache es tolerant (800 -> 0800)
                    const padded = timeStr.toString().padStart(4, '0');
                    const h = parseInt(padded.substr(0, 2));
                    const m = parseInt(padded.substr(2, 2));
                    return (h * 60) + m;
                }
            },
            
            // Berechnet Dauer eines Blocks in Minuten
            calcBlock() {
                return (start, end) => {
                    const s = this.parseTime(start);
                    const e = this.parseTime(end);
                    if (e > s) return e - s;
                    return 0;
                }
            },

            // --- HAUPTRECHNUNG ---
            totalMinuten() {
                let buro = this.calcBlock(this.buroStart, this.buroEnde);
                let home = this.calcBlock(this.homeStart, this.homeEnde);
                let arzt = parseInt(this.arztMin) || 0;

                let summe = buro + home + arzt;

                // Pausenautomatik (Beta)
                this.pauseAbzug = 0;
                if (summe > 360) { // Nach 6 Stunden (360 min)
                    this.pauseAbzug = 30; // Ziehe 30 min ab
                    summe = summe - 30;
                }

                return summe > 0 ? summe : 0;
            },

            saldo() {
                const ist = this.totalMinuten / 60;
                const wert = ist - this.sollStunden;
                return wert.toFixed(2) + ' h';
            },

            restSoll() {
                const ist = this.totalMinuten / 60;
                const rest = this.sollStunden - ist;
                return rest > 0 ? rest.toFixed(2) + ' h' : '0.00 h';
            },

            buroQuote() {
                const buro = this.calcBlock(this.buroStart, this.buroEnde);
                const gesamt = this.totalMinuten + this.pauseAbzug; // Brutto rechnen f√ºr Quote? (Kl√§rung SAP)
                if (gesamt === 0) return 0;
                return Math.round((buro / gesamt) * 100);
            }
        },
        methods: {
            formatMinutes(mins) {
                let h = Math.floor(mins / 60);
                let m = mins % 60;
                return h + "," + (m < 10 ? '0' : '') + m; // Dezimal-√§hnliche Anzeige
            },
            saveData() {
                console.log("Speichere Daten:", {
                    buro: this.buroStart + '-' + this.buroEnde,
                    home: this.homeStart + '-' + this.homeEnde
                });
                alert("Daten lokal berechnet (Speichern folgt im n√§chsten Schritt!)");
            }
        },
        mounted() {
            console.log("ü¶• TimeSloth Dashboard V2 geladen.");
            // Testwerte setzen
            this.buroStart = "0800";
            this.buroEnde = "1630";
        }
    }).mount('#app');
</script>
{% endblock %}