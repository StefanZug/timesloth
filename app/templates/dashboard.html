{% extends "base.html" %}

{% block content %}
<style>
    /* --- DARK MODE FIXES & COLORS --- */
    [data-bs-theme="dark"] body { background-color: #121212; color: #e0e0e0; }
    [data-bs-theme="dark"] .card { background-color: #1e1e1e; border-color: #333; }
    [data-bs-theme="dark"] .form-control { background-color: #2d2d2d; border: 1px solid #444; color: #fff; }
    
    /* Farben */
    :root {
        --color-office: #4dabf7;
        --color-home: #da77f2;
        --color-sick: #ff6b6b;
    }
    
    .border-office { border-left: 5px solid var(--color-office) !important; }
    .border-home { border-left: 5px solid var(--color-home) !important; }
    .text-office { color: var(--color-office); }
    .text-home { color: var(--color-home); }

    /* --- WEEK VIEW (Desktop) --- */
    .week-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        overflow-x: auto;
        padding-bottom: 5px;
    }
    
    .day-card {
        flex: 1;
        min-width: 100px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        opacity: 0.7;
    }
    
    .day-card:hover { opacity: 1; transform: translateY(-2px); }
    
    .day-card.active {
        border-color: var(--sloth-primary, #5c7cfa);
        background-color: rgba(92, 124, 250, 0.1);
        opacity: 1;
        font-weight: bold;
    }

    .mini-indicator {
        height: 4px;
        width: 100%;
        margin-top: 4px;
        border-radius: 2px;
        background-color: #eee;
    }
    .bg-office { background-color: var(--color-office); }
    .bg-home { background-color: var(--color-home); }

    /* --- FAB SAVE BUTTON (Mobile) --- */
    .fab-save {
        position: fixed; bottom: 20px; right: 20px;
        width: 60px; height: 60px; border-radius: 50%;
        font-size: 24px; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000;
    }
</style>

<div id="app" class="container mt-3" v-cloak>

    <div class="card shadow-sm border-0 mb-4 text-white" 
         style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px;">
        <div class="card-body p-3">
            <div class="row text-center">
                <div class="col-4 border-end border-white-50">
                    <span class="d-block h4 mb-0 fw-bold">[[ stats.quote ]]%</span>
                    <small class="text-uppercase opacity-75" style="font-size: 0.7rem;">Büro</small>
                </div>
                <div class="col-4 border-end border-white-50">
                    <span class="d-block h4 mb-0 fw-bold">[[ stats.saldo ]]</span>
                    <small class="text-uppercase opacity-75" style="font-size: 0.7rem;">Saldo</small>
                </div>
                <div class="col-4">
                    <span class="d-block h4 mb-0 fw-bold">[[ stats.rest ]]</span>
                    <small class="text-uppercase opacity-75" style="font-size: 0.7rem;">Rest</small>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm" @click="changeDay(-1)">
            <i class="bi bi-chevron-left"></i>
        </button>
        
        <h5 class="m-0 fw-bold d-md-none">[[ displayDateMobile ]]</h5>
        <h5 class="m-0 fw-bold d-none d-md-block">KW [[ currentKw ]] - [[ displayMonth ]]</h5>
        
        <button class="btn btn-outline-secondary btn-sm" @click="changeDay(1)">
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>

    <div class="week-container d-none d-md-flex">
        <div v-for="day in weekDays" 
             class="card day-card p-2 shadow-sm"
             :class="{ 'active': day.iso === form.dateIso, 'bg-light': isWeekend(day.obj) }"
             @click="jumpToDate(day.obj)">
             
            <div class="small text-muted text-uppercase">[[ day.name ]]</div>
            <div class="h5 mb-1">[[ day.dayNum ]]</div>
            
            <div class="mini-indicator" 
                 :class="{ 'bg-office': day.hasOffice, 'bg-home': day.hasHome }">
            </div>
        </div>
    </div>

    <div class="animate-fade-in">
        
        <div class="card mb-3 border-office shadow-sm">
            <div class="card-body p-3">
                <div class="d-flex align-items-center mb-2">
                    <div class="text-office me-3"><i class="bi bi-building-fill fs-3"></i></div>
                    <div class="flex-grow-1 fw-bold">Büro Anwesenheit</div>
                </div>
                <div class="input-group input-group-lg">
                    <input type="tel" class="form-control text-center" v-model="form.buroStart" placeholder="0800" maxlength="4">
                    <span class="input-group-text border-0 bg-transparent">-</span>
                    <input type="tel" class="form-control text-center" v-model="form.buroEnde" placeholder="1630" maxlength="4">
                </div>
            </div>
        </div>

        <div class="card mb-3 border-home shadow-sm">
            <div class="card-body p-3">
                <div class="d-flex align-items-center mb-2">
                    <div class="text-home me-3"><i class="bi bi-house-heart-fill fs-3"></i></div>
                    <div class="flex-grow-1 fw-bold">Home Office</div>
                </div>
                <div class="input-group input-group-lg">
                    <input type="tel" class="form-control text-center" v-model="form.homeStart" placeholder="Start" maxlength="4">
                    <span class="input-group-text border-0 bg-transparent">-</span>
                    <input type="tel" class="form-control text-center" v-model="form.homeEnde" placeholder="Ende" maxlength="4">
                </div>
            </div>
        </div>

        <div class="card mb-3 border-start border-3 border-danger shadow-sm">
            <div class="card-body p-3 d-flex align-items-center">
                <div class="text-danger me-3"><i class="bi bi-bandaid-fill fs-3"></i></div>
                <div class="flex-grow-1 fw-bold">Arzt / Behörde</div>
                <div style="width: 100px;">
                    <input type="number" class="form-control text-center" v-model="form.arztMin" placeholder="Min">
                </div>
            </div>
        </div>

        <div class="mb-5">
            <input type="text" class="form-control p-3" placeholder="Notiz für diesen Tag..." v-model="form.kommentar">
        </div>
        
        <div class="text-center text-muted small mt-4 mb-5">
            <div v-if="loading" class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <div v-else>
                Gesamt: <strong>[[ formatMinutes(dailySum) ]] h</strong>
                <span v-if="dailyPause > 0" class="text-warning ms-2">(Pause: -[[ dailyPause ]]m)</span>
            </div>
        </div>
    </div>

    <button class="btn btn-primary fab-save text-white" @click="saveEntry">
        <i class="bi bi-floppy2-fill"></i>
    </button>

    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">⚙️ Einstellungen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveSettings">
                        <div class="mb-3">
                            <label class="form-label">Wochenstunden (Soll)</label>
                            <input type="number" class="form-control" v-model="settings.sollStunden" step="0.1">
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Speichern</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    const { createApp } = Vue;

    createApp({
        delimiters: ['[[', ']]'], 
        data() {
            return {
                currentDateObj: new Date(),
                entriesCache: [], // Alle Einträge des Monats
                loading: false,
                
                // Aktuelles Formular
                form: {
                    dateIso: '',
                    buroStart: '', buroEnde: '',
                    homeStart: '', homeEnde: '',
                    arztMin: '', kommentar: ''
                },
                
                // Einstellungen
                settings: {
                    sollStunden: 38.5
                }
            }
        },
        computed: {
            // --- DATUM HELFER ---
            displayDateMobile() {
                return this.currentDateObj.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit' });
            },
            displayMonth() {
                return this.currentDateObj.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            },
            currentKw() {
                // Simplifizierte KW Berechnung
                const date = new Date(this.currentDateObj.getTime());
                date.setHours(0, 0, 0, 0);
                date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
                const week1 = new Date(date.getFullYear(), 0, 4);
                return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            },
            
            // --- WOCHENANSICHT GENERATOR ---
            weekDays() {
                // Finde den Montag der aktuellen Woche
                let curr = new Date(this.currentDateObj);
                let day = curr.getDay(); 
                let diff = curr.getDate() - day + (day == 0 ? -6:1); // adjust when day is sunday
                let monday = new Date(curr.setDate(diff));
                
                let week = [];
                for (let i=0; i<7; i++) {
                    let d = new Date(monday);
                    d.setDate(monday.getDate() + i);
                    let iso = d.toISOString().split('T')[0];
                    
                    // Prüfen ob Daten im Cache existieren für Indikatoren
                    let entry = this.entriesCache.find(e => e.date === iso);
                    let hasOffice = entry && entry.office_times && entry.office_times.length > 0;
                    let hasHome = entry && entry.home_times && entry.home_times.length > 0;

                    week.push({
                        obj: d,
                        iso: iso,
                        name: d.toLocaleDateString('de-DE', { weekday: 'short' }),
                        dayNum: d.getDate(),
                        hasOffice: hasOffice,
                        hasHome: hasHome
                    });
                }
                return week;
            },

            // --- BERECHNUNGEN AKTUELLE SEITE ---
            dailySum() {
                let buro = this.calcDiff(this.form.buroStart, this.form.buroEnde);
                let home = this.calcDiff(this.form.homeStart, this.form.homeEnde);
                let arzt = parseInt(this.form.arztMin) || 0;
                let raw = buro + home + arzt;
                // Pause abziehen (> 6h -> 30min)
                if (raw > 360) return raw - 30;
                return raw > 0 ? raw : 0;
            },
            dailyPause() {
                let raw = this.calcDiff(this.form.buroStart, this.form.buroEnde) + 
                          this.calcDiff(this.form.homeStart, this.form.homeEnde) + 
                          (parseInt(this.form.arztMin) || 0);
                return raw > 360 ? 30 : 0;
            },

            // --- GESAMT STATISTIK ---
            stats() {
                // Wir summieren ALLES im Cache (ganzer Monat)
                let totalMin = 0;
                let officeMin = 0;
                
                this.entriesCache.forEach(e => {
                    // Zeiten parsen (wir nehmen hier vereinfacht den ersten Block an)
                    let o = e.office_times[0] ? this.calcDiff(e.office_times[0].start, e.office_times[0].end) : 0;
                    let h = e.home_times[0] ? this.calcDiff(e.home_times[0].start, e.home_times[0].end) : 0;
                    let a = e.doctor_minutes || 0;
                    
                    let daySum = o + h + a;
                    if(daySum > 360) daySum -= 30; // Pause
                    
                    totalMin += Math.max(0, daySum);
                    officeMin += o; // Für Quote (Brutto oder Netto ist hier Interpretationssache, nehmen wir Brutto-Zeit)
                });

                // Soll berechnen (Anzahl Arbeitstage bis heute * Soll/Tag)
                // Das ist komplexer, wir machen es simpel: Soll vs Ist des Monats
                // Soll: Wir nehmen an User arbeitet Mo-Fr
                // Hier vereinfacht: Saldo = Ist - (SollStunden * 4.33 Wochen / Arbeitstage... zu komplex)
                // Simpler: Saldo = Ist Stunden - (Anzahl Werktage im Monat * 7.7)
                
                let istStunden = totalMin / 60;
                let quote = totalMin > 0 ? Math.round((officeMin / totalMin) * 100) : 0;
                
                return {
                    quote: quote,
                    saldo: istStunden.toFixed(2) + ' h', // Platzhalter Logik
                    rest: '0.00 h'
                };
            }
        },
        methods: {
            // --- TOOLS ---
            isWeekend(date) { return date.getDay() === 0 || date.getDay() === 6; },
            
            formatMinutes(mins) {
                let h = Math.floor(mins / 60);
                let m = mins % 60;
                return h + "," + (m < 10 ? '0' : '') + m;
            },
            
            parseTime(t) {
                if(!t || t.length < 3) return 0;
                let s = t.toString().padStart(4, '0');
                return parseInt(s.substring(0,2))*60 + parseInt(s.substring(2,4));
            },
            
            calcDiff(start, end) {
                let s = this.parseTime(start);
                let e = this.parseTime(end);
                return e > s ? e - s : 0;
            },

            // --- NAVIGATION & API ---
            changeDay(offset) {
                let d = new Date(this.currentDateObj);
                d.setDate(d.getDate() + offset);
                this.jumpToDate(d);
            },
            
            jumpToDate(dateObj) {
                this.currentDateObj = dateObj;
                this.updateFormFromCache();
                
                // Wenn Monat gewechselt, lade neue Daten
                // (Optimierung: Könnte man checken. Einfachheitshalber laden wir neu wenn nötig)
                this.loadData(); 
            },

            async loadData() {
                this.loading = true;
                const isoMonth = this.currentDateObj.toISOString().substring(0, 7);
                
                try {
                    const res = await axios.get(`/api/get_entries?month=${isoMonth}`);
                    this.entriesCache = res.data;
                    this.updateFormFromCache();
                } catch(e) {
                    console.error(e);
                } finally {
                    this.loading = false;
                }
            },

            updateFormFromCache() {
                const isoDate = this.currentDateObj.toISOString().split('T')[0];
                this.form.dateIso = isoDate;
                
                const entry = this.entriesCache.find(e => e.date === isoDate);
                
                if (entry) {
                    const office = entry.office_times[0] || {};
                    const home = entry.home_times[0] || {};
                    
                    this.form.buroStart = office.start || '';
                    this.form.buroEnde = office.end || '';
                    this.form.homeStart = home.start || '';
                    this.form.homeEnde = home.end || '';
                    this.form.arztMin = entry.doctor_minutes || '';
                    this.form.kommentar = entry.comment || '';
                } else {
                    // Reset
                    this.form.buroStart = ''; this.form.buroEnde = '';
                    this.form.homeStart = ''; this.form.homeEnde = '';
                    this.form.arztMin = ''; this.form.kommentar = '';
                }
            },

            async saveEntry() {
                const payload = {
                    date: this.form.dateIso,
                    office_times: (this.form.buroStart && this.form.buroEnde) ? 
                        [{start: this.form.buroStart, end: this.form.buroEnde}] : [],
                    home_times: (this.form.homeStart && this.form.homeEnde) ? 
                        [{start: this.form.homeStart, end: this.form.homeEnde}] : [],
                    doctor_minutes: this.form.arztMin,
                    comment: this.form.kommentar
                };

                try {
                    await axios.post('/api/save_entry', payload);
                    
                    // Cache aktualisieren (damit Wochenansicht sofort updatet)
                    // Wir laden einfach neu, ist sicherer
                    await this.loadData();
                    
                    // Visuelles Feedback am Button
                    const btn = document.querySelector('.fab-save');
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    setTimeout(() => {
                        btn.classList.add('btn-primary');
                        btn.classList.remove('btn-success');
                    }, 1000);
                    
                } catch(e) {
                    alert("Fehler beim Speichern");
                }
            },
            
            saveSettings() {
                // Hier könntest du eine API Route /api/settings aufrufen
                // Aktuell speichern wir es nur lokal im Modal zum Schein
                const modalEl = document.getElementById('settingsModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                alert("Einstellungen gespeichert (Dummy)");
            }
        },
        mounted() {
            // 1. Daten laden
            this.loadData();
            
            // 2. Globalen Hook für Base.html Navbar setzen
            // Das behebt den Fehler "openSettings is not defined"
            window.openSettings = () => {
                const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
                modal.show();
            };
        }
    }).mount('#app');
</script>
{% endblock %}