{% extends "base.html" %}

{% block content %}
<style>
    /* --- STYLES & CONTRAST FIXES --- */
    
    /* Hintergrund leicht abdunkeln f√ºr Kontrast im Light Mode */
    [data-bs-theme="light"] body { background-color: #f8f9fa; }
    [data-bs-theme="light"] .card { border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    
    /* Tabellen Kontraste */
    .table-hover tbody tr:hover { background-color: rgba(92, 124, 250, 0.05); }
    .table-striped tbody tr:nth-of-type(odd) { background-color: rgba(0,0,0,0.015); }
    
    [data-bs-theme="dark"] body { background-color: #121212; color: #e0e0e0; }
    [data-bs-theme="dark"] .card { background-color: #1e1e1e; border-color: #333; }
    [data-bs-theme="dark"] .table { --bs-table-color: #e0e0e0; --bs-table-bg: #1e1e1e; --bs-table-border-color: #333; }
    
    .type-office { border-left: 5px solid #4dabf7; }
    .type-home { border-left: 5px solid #da77f2; }
    .type-doctor { border-left: 5px solid #ff6b6b; }
    
    .bg-office { background-color: #4dabf7; color: white; }
    .bg-home { background-color: #da77f2; color: white; }
    
    /* Status Toggles */
    .status-toggle {
        cursor: pointer; opacity: 0.3; transition: all 0.2s; font-weight: bold;
        width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;
        border-radius: 8px; border: 1px solid #adb5bd; font-size: 0.9rem;
        background-color: var(--bs-body-bg);
    }
    .status-toggle.active { opacity: 1; border-color: transparent; transform: scale(1.1); color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .st-holiday.active { background-color: #868e96; } 
    .st-vacation.active { background-color: #fcc419; } 
    .st-sick.active { background-color: #fa5252; }     

    /* Quota Card */
    .quota-card {
        background: var(--bs-body-bg); border-radius: 12px; padding: 15px; margin-bottom: 20px;
        border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .progress-sloth { height: 10px; border-radius: 5px; background-color: #e9ecef; margin-top: 5px; overflow: hidden; }
    .progress-bar-sloth { background-color: #fcc419; height: 100%; transition: width 0.5s; }

    /* View Switcher */
    .view-switcher {
        background: #e9ecef; border-radius: 20px; padding: 4px; display: inline-flex; margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    [data-bs-theme="dark"] .view-switcher { background: #2d2d2d; border-color: #444; }
    
    .view-btn {
        border: none; background: transparent; padding: 5px 15px; border-radius: 16px; 
        font-size: 0.9rem; color: #666; transition: all 0.2s;
    }
    .view-btn.active { background: var(--bs-body-bg); color: var(--sloth-primary); font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    [data-bs-theme="dark"] .view-btn.active { color: white; background: #555; }
    
    .cursor-pointer { cursor: pointer; }
</style>

<div id="app" class="container mt-3 mb-5" v-cloak>

    <div class="quota-card">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="text-muted small fw-bold text-uppercase">B√ºro-Quote (40%)</span>
            <span class="text-danger fw-bold fs-5">[[ quota.needed ]] h</span>
        </div>
        <div class="d-flex justify-content-between small mb-1 text-muted">
            <span>Ist: [[ quota.current ]] h</span>
            <span>Ziel: [[ quota.target ]] h</span>
        </div>
        <div class="progress-sloth">
            <div class="progress-bar-sloth" :style="{ width: quota.percent + '%' }"></div>
        </div>
        <div class="text-end mt-2">
            <span class="badge bg-secondary opacity-75 fw-normal" style="font-size: 0.7rem;">
                Abz√ºge (U/K/F): [[ quota.deduction ]] h
            </span>
        </div>
    </div>

    <div class="text-center">
        <div class="view-switcher">
            <button class="view-btn" :class="{active: viewMode === 'day'}" @click="viewMode = 'day'">
                <i class="bi bi-calendar-day"></i> Tag
            </button>
            <button class="view-btn" :class="{active: viewMode === 'month'}" @click="viewMode = 'month'">
                <i class="bi bi-table"></i> Liste
            </button>
        </div>
    </div>

    <div v-show="viewMode === 'day'" class="animate-fade">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-secondary btn-sm rounded-circle shadow-sm" @click="shiftDay(-1)"><i class="bi bi-chevron-left"></i></button>
            <h5 class="m-0 fw-bold">[[ displayDateDayView ]]</h5>
            <button class="btn btn-outline-secondary btn-sm rounded-circle shadow-sm" @click="shiftDay(1)"><i class="bi bi-chevron-right"></i></button>
        </div>

        <div v-if="!isNonWorkDay && prediction.target !== '--:--'" class="card mb-3 border-0 bg-light shadow-sm">
            <div class="card-body py-2 d-flex justify-content-around">
                <div class="text-center">
                    <small class="text-muted d-block text-uppercase" style="font-size: 0.65rem">Soll (7.7h)</small>
                    <strong class="text-primary">[[ prediction.target ]]</strong>
                </div>
                <div class="vr opacity-25"></div>
                <div class="text-center">
                    <small class="text-muted d-block text-uppercase" style="font-size: 0.65rem">Max (10h)</small>
                    <strong class="text-danger">[[ prediction.max ]]</strong>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-center gap-2 mb-4">
            <div class="status-toggle st-holiday" :class="{active: dayStatus === 'F'}" @click="toggleStatus('F')">F</div>
            <div class="status-toggle st-vacation" :class="{active: dayStatus === 'U'}" @click="toggleStatus('U')">U</div>
            <div class="status-toggle st-sick" :class="{active: dayStatus === 'K'}" @click="toggleStatus('K')">K</div>
        </div>

        <div v-if="!isNonWorkDay">
            <transition-group name="list" tag="div">
                <div v-for="(block, index) in blocks" :key="block.id" class="card mb-2 shadow-sm border" :class="'type-' + block.type">
                    <div class="card-body p-2 d-flex align-items-center gap-2">
                        <div class="dropdown">
                            <button class="btn btn-sm dropdown-toggle text-white shadow-sm" :class="'bg-' + block.type" type="button" data-bs-toggle="dropdown" style="width: 40px;">
                                <i class="bi" :class="getTypeIcon(block.type)"></i>
                            </button>
                            <ul class="dropdown-menu shadow">
                                <li><a class="dropdown-item" @click="updateBlock(block, 'type', 'office')">üè¢ B√ºro</a></li>
                                <li><a class="dropdown-item" @click="updateBlock(block, 'type', 'home')">üè† Home</a></li>
                                <li><a class="dropdown-item text-danger" @click="updateBlock(block, 'type', 'doctor')">üöë Arzt</a></li>
                            </ul>
                        </div>
                        <input type="text" class="form-control text-center p-1 fw-bold" v-model="block.start" placeholder="08:00" @blur="formatTimeInput(block, 'start')" @input="triggerAutoSave">
                        <span>-</span>
                        <input type="text" class="form-control text-center p-1 fw-bold" v-model="block.end" placeholder="16:30" @blur="formatTimeInput(block, 'end')" @input="triggerAutoSave">
                        <button class="btn btn-link text-muted p-0 ms-auto" @click="removeBlock(index)"><i class="bi bi-x-lg"></i></button>
                    </div>
                </div>
            </transition-group>

            <div class="d-grid gap-2 mt-3">
                <button class="btn btn-outline-secondary border-dashed" @click="addBlock('office')" style="border-style: dashed; opacity: 0.7;">
                    <i class="bi bi-plus-lg"></i> Eintrag
                </button>
            </div>
            
            <div class="text-center mt-4 text-muted small bg-white p-2 rounded shadow-sm border">
                <div class="d-flex justify-content-center gap-3">
                    <span>SAP: <strong>[[ formatH(totals.sapTime) ]]</strong></span>
                    <div class="vr"></div>
                    <span>CATS: <strong>[[ formatH(totals.catsTime) ]]</strong></span>
                </div>
                <div v-if="totals.pause > 0" class="text-warning mt-1" style="font-size: 0.8rem;">
                    <i class="bi bi-cup-hot"></i> Pause: -[[ totals.pause ]]m
                </div>
                <div class="fw-bold mt-2 text-primary fs-6 border-top pt-1">Saldo: [[ totals.saldo ]]</div>
            </div>
        </div>
        
        <div v-else class="alert text-center mt-3 shadow-sm border" :class="statusAlertClass">
            <h5 class="m-0">[[ getStatusText(dayStatus) ]]</h5>
        </div>

    </div>

    <div v-show="viewMode === 'month'" class="animate-fade">
        
        <div class="d-flex justify-content-between align-items-center mb-3 bg-white p-2 rounded shadow-sm border">
            <button class="btn btn-sm btn-light" @click="shiftMonth(-1)"><i class="bi bi-chevron-left"></i></button>
            <h5 class="m-0 fw-bold">[[ displayMonthName ]]</h5>
            <button class="btn btn-sm btn-light" @click="shiftMonth(1)"><i class="bi bi-chevron-right"></i></button>
        </div>

        <div class="table-responsive bg-white rounded shadow-sm border">
            <table class="table table-hover table-striped mb-0 text-center align-middle" style="font-size: 0.9rem;">
                <thead class="table-light">
                    <tr>
                        <th class="text-start ps-3 py-3">Datum</th>
                        <th>Summe</th>
                        <th>SAP</th>
                        <th>Info</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="day in monthDays" :key="day.iso" @click="jumpToDay(day.iso)" class="cursor-pointer">
                        <td class="text-start ps-3">
                            <div class="fw-bold" :class="{'text-primary': day.isToday}">
                                [[ day.dayShort ]]., [[ day.dateNum ]].
                            </div>
                            <div class="text-muted opacity-75" style="font-size: 0.7rem;">KW [[ day.kw ]]</div>
                        </td>
                        
                        <td :class="{'opacity-25': day.sapTime == 0, 'fw-bold': day.sapTime > 0}">
                            [[ day.sapTime > 0 ? formatH(day.sapTime) : '-' ]]
                        </td>
                        
                        <td class="text-primary fw-bold">
                            [[ day.sapTime > 0 ? formatH(day.sapTime) : '0' ]]
                        </td>
                        
                        <td>
                            <span v-if="day.status" class="badge rounded-pill shadow-sm" 
                                  :class="{'bg-secondary': day.status=='F', 'bg-warning text-dark': day.status=='U', 'bg-danger': day.status=='K'}">
                                [[ day.status ]]
                            </span>
                            <span v-else-if="day.isWeekend" class="text-muted small" style="font-size: 0.7rem;">WE</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 99;">
        <div v-if="saveState === 'saved'" class="text-success bg-white rounded-circle shadow p-2">
            <i class="bi bi-check-lg fs-4"></i>
        </div>
        <div v-if="saveState === 'saving'" class="text-warning bg-white rounded-circle shadow p-2">
            <div class="spinner-border spinner-border-sm"></div>
        </div>
    </div>

</div>
{% endblock %}


{% block scripts %}
<script>
    const { createApp } = Vue;

    createApp({
        delimiters: ['[[', ']]'], 
        data() {
            return {
                currentDateObj: new Date(), // Aktuell gew√§hlter Tag
                viewMode: 'day',
                
                dayStatus: null, 
                blocks: [], 
                
                entriesCache: [],
                holidaysMap: {},
                
                saveState: 'idle', 
                saveTimer: null,
                
                settings: {
                    sollStunden: 7.70,
                    officeTarget: 66.67,
                    deductionPerDay: 3.08,
                    arztStart: 480, arztEnde: 972
                }
            }
        },
        computed: {
            // Hilfsfunktion: Datum formatieren OHNE Zeitzonen-Probleme
            // Wir nutzen locale Komponenten und bauen den String selbst
            isoDate() { return this.formatIsoDate(this.currentDateObj); },
            isoMonth() { return this.isoDate.substring(0, 7); },

            displayDateDayView() {
                return this.currentDateObj.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });
            },
            
            displayMonthName() {
                // Zeigt "Dezember 2025" basierend auf currentDateObj
                return this.currentDateObj.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            },

            isNonWorkDay() { return ['F', 'U', 'K'].includes(this.dayStatus); },
            
            statusAlertClass() {
                if(this.dayStatus === 'F') return 'alert-secondary';
                if(this.dayStatus === 'U') return 'alert-warning';
                if(this.dayStatus === 'K') return 'alert-danger';
                return '';
            },

            totals() {
                let sapMin = 0; let catsMin = 0;
                this.blocks.forEach(b => {
                    let s = this.toMin(b.start); let e = this.toMin(b.end);
                    if (s >= e) return;
                    let dur = e - s;
                    if (b.type === 'doctor') {
                        let vs = Math.max(s, this.settings.arztStart);
                        let ve = Math.min(e, this.settings.arztEnde);
                        if (ve > vs) sapMin += (ve - vs);
                    } else {
                        sapMin += dur; catsMin += dur;
                    }
                });
                let pause = 0;
                if (sapMin > 360) { pause = 30; sapMin -= 30; catsMin -= 30; }
                let ist = sapMin / 60;
                let saldoVal = this.isNonWorkDay ? 0 : (ist - this.settings.sollStunden);
                return { sapTime: Math.max(0, sapMin), catsTime: Math.max(0, catsMin), pause, saldo: (saldoVal > 0 ? '+' : '') + saldoVal.toFixed(2) + ' h' };
            },

            prediction() {
                if (this.blocks.length === 0 || this.isNonWorkDay) return { target: '--:--', max: '--:--' };
                let firstStart = 9999; let lastEnd = 0;
                this.blocks.forEach(b => {
                    let s = this.toMin(b.start); let e = this.toMin(b.end);
                    if (s > 0 && s < firstStart) firstStart = s;
                    if (e > lastEnd) lastEnd = e;
                });
                if (firstStart === 9999) return { target: '--:--', max: '--:--' };
                let currentNetto = this.totals.sapTime;
                let remaining = (this.settings.sollStunden * 60) - currentNetto;
                if (remaining <= 0) return { target: '‚úî', max: '...' };
                let finish = lastEnd + remaining;
                if (this.totals.pause === 0 && (currentNetto + remaining) > 360) finish += 30;
                let maxTime = firstStart + 630; 
                return { target: this.minToString(finish), max: this.minToString(maxTime) };
            },

            quota() {
                let officeMinSum = 0;
                let deductionCount = 0;
                // Z√§hle nur relevante Eintr√§ge
                this.entriesCache.forEach(e => {
                    if(['F','U','K'].includes(e.status)) deductionCount++;
                    else {
                        (e.blocks || []).forEach(b => {
                            if(b.type === 'office') {
                                let s = this.toMin(b.start); let e = this.toMin(b.end);
                                if(e>s) officeMinSum += (e - s);
                            }
                        });
                    }
                });
                // Erg√§nze Feiertage aus Map, die noch keinen Eintrag haben
                for(let dateStr in this.holidaysMap) {
                    if(!this.entriesCache.find(e => e.date === dateStr)) deductionCount++;
                }

                let deductionTotal = deductionCount * this.settings.deductionPerDay;
                let targetAdjusted = Math.max(0, this.settings.officeTarget - deductionTotal);
                let currentHours = officeMinSum / 60;
                let percent = targetAdjusted > 0 ? (currentHours / targetAdjusted) * 100 : 100;
                
                return {
                    current: currentHours.toFixed(2),
                    target: targetAdjusted.toFixed(2),
                    deduction: deductionTotal.toFixed(2),
                    needed: Math.max(0, targetAdjusted - currentHours).toFixed(2),
                    percent: Math.min(100, percent)
                };
            },

            monthDays() {
                let days = [];
                // Wir bauen die Tage basierend auf dem aktuellen Monat in currentDateObj
                let year = this.currentDateObj.getFullYear();
                let month = this.currentDateObj.getMonth();
                
                // Erster Tag des Monats
                let date = new Date(year, month, 1);
                const todayIso = this.formatIsoDate(new Date());

                while (date.getMonth() === month) {
                    let iso = this.formatIsoDate(date); // Sichere Methode!
                    let entry = this.entriesCache.find(e => e.date === iso);
                    let holiday = this.holidaysMap[iso];
                    let status = entry ? entry.status : (holiday ? 'F' : null);
                    
                    let sapT = 0;
                    if(entry && !status) {
                        let tempSap = 0;
                        (entry.blocks||[]).forEach(b => {
                            let s = this.toMin(b.start); let e = this.toMin(b.end);
                            if(e>s) {
                                if(b.type==='doctor') {
                                    let vs = Math.max(s, this.settings.arztStart); let ve = Math.min(e, this.settings.arztEnde);
                                    if(ve>vs) tempSap += (ve-vs);
                                } else tempSap += (e-s);
                            }
                        });
                        if(tempSap > 360) tempSap -= 30;
                        sapT = Math.max(0, tempSap);
                    }

                    days.push({
                        iso: iso,
                        dateNum: date.getDate(),
                        dayShort: date.toLocaleDateString('de-DE', { weekday: 'short' }),
                        kw: this.getKw(date),
                        status: status,
                        sapTime: sapT,
                        isWeekend: (date.getDay()===0 || date.getDay()===6),
                        isToday: (iso === todayIso)
                    });
                    
                    // N√§chster Tag
                    date.setDate(date.getDate() + 1);
                }
                return days;
            }
        },
        methods: {
            // --- CORE DATE FIX ---
            // Diese Funktion verhindert das "einen Tag zur√ºck"-Problem
            formatIsoDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            formatTimeInput(block, field) {
                let val = block[field];
                if(!val) return;
                let clean = val.replace(/[^0-9]/g, '');
                let h = 0, m = 0;
                if (clean.length <= 2) h = parseInt(clean); 
                else if (clean.length === 3) { h = parseInt(clean.substring(0,1)); m = parseInt(clean.substring(1,3)); } 
                else { h = parseInt(clean.substring(0,2)); m = parseInt(clean.substring(2,4)); }
                if(h > 23) h = 23; if(m > 59) m = 59;
                block[field] = h.toString().padStart(2,'0') + ':' + m.toString().padStart(2,'0');
                this.triggerAutoSave();
            },
            
            toMin(str) {
                if (!str || str.length < 3) return 0;
                let clean = str.replace(':','').padStart(4, '0');
                return (parseInt(clean.substr(0,2))*60) + parseInt(clean.substr(2,2));
            },
            minToString(min) {
                let h = Math.floor(min / 60); let m = min % 60;
                return h.toString().padStart(2,'0') + ':' + m.toString().padStart(2,'0');
            },
            formatH(min) { return (min / 60).toFixed(2); },
            getTypeIcon(t) { return (t==='office'?'bi-building':(t==='home'?'bi-house':'bi-bandaid')); },
            getStatusText(s) { return (s==='F'?'Feiertag üéÑ':(s==='U'?'Urlaub üå¥':(s==='K'?'Krank ü§í':''))); },
            getKw(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            },

            // --- NAVIGATION ---
            shiftDay(offset) {
                let d = new Date(this.currentDateObj);
                d.setDate(d.getDate() + offset);
                // Check ob Monatswechsel
                let oldMonth = this.currentDateObj.getMonth();
                this.currentDateObj = d;
                if(d.getMonth() !== oldMonth) this.loadMonthData(); // Neu laden wenn Monat wechselt
                else this.loadFromCache();
            },
            
            shiftMonth(offset) {
                // √Ñndert nur den Monat, Tag wird auf 1. gesetzt um √úberlauf zu vermeiden
                let d = new Date(this.currentDateObj);
                d.setDate(1); // Sicherheitshalber auf den Ersten
                d.setMonth(d.getMonth() + offset);
                this.currentDateObj = d;
                this.loadMonthData();
            },

            jumpToDay(iso) {
                this.currentDateObj = new Date(iso);
                this.viewMode = 'day';
                this.loadFromCache();
            },

            toggleStatus(s) {
                this.dayStatus = (this.dayStatus === s) ? null : s;
                this.triggerAutoSave();
            },
            addBlock(type) {
                this.blocks.push({ id: Date.now(), type: type, start: '', end: '' });
                this.triggerAutoSave();
            },
            removeBlock(idx) {
                this.blocks.splice(idx, 1);
                this.triggerAutoSave();
            },
            updateBlock(block, field, val) {
                block[field] = val;
                this.triggerAutoSave();
            },

            triggerAutoSave() {
                this.saveState = 'saving';
                if(this.saveTimer) clearTimeout(this.saveTimer);
                this.saveTimer = setTimeout(() => { this.saveData(); }, 1000);
            },

            async saveData() {
                const payload = { date: this.isoDate, blocks: this.blocks, status: this.dayStatus };
                try {
                    let existing = this.entriesCache.find(e => e.date === this.isoDate);
                    if(existing) { existing.blocks = JSON.parse(JSON.stringify(this.blocks)); existing.status = this.dayStatus; } 
                    else { this.entriesCache.push(JSON.parse(JSON.stringify(payload))); }
                    await axios.post('/api/save_entry', payload);
                    this.saveState = 'saved';
                    setTimeout(() => { if(this.saveState === 'saved') this.saveState = 'idle'; }, 2000);
                } catch(e) { console.error(e); this.saveState = 'idle'; }
            },

            async loadMonthData() {
                try {
                    const res = await axios.get(`/api/get_entries?month=${this.isoMonth}`);
                    this.entriesCache = res.data.entries;
                    this.holidaysMap = res.data.holidays || {};
                    this.loadFromCache();
                } catch(e) { console.error(e); }
            },

            loadFromCache() {
                const iso = this.isoDate;
                let isHol = !!this.holidaysMap[iso];
                let entry = this.entriesCache.find(e => e.date === iso);
                if (entry) {
                    this.blocks = JSON.parse(JSON.stringify(entry.blocks || []));
                    this.dayStatus = entry.status;
                } else {
                    this.blocks = [];
                    this.dayStatus = isHol ? 'F' : null;
                }
            }
        },
        mounted() {
            this.loadMonthData();
        }
    }).mount('#app');
</script>
{% endblock %}